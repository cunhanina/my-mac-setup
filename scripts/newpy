#!/bin/zsh
# Load your existing styles
source ~/bin/_styles.sh

# --- FALLBACKS ---
# If your _styles.sh doesn't have these, we define simple versions here
# to prevent "command not found" errors.
if ! command -v step &> /dev/null; then
  step() { echo "  ‚ûú $1"; }
fi
if ! command -v info &> /dev/null; then
  info() { echo "  ‚ÑπÔ∏è  $1"; }
fi
# -----------------

if [ -z "$1" ]; then
  err "Usage: newpy <project_name>"
  exit 1
fi

NAME=$1
# Convert hyphens to underscores for the python package name
PKG_NAME=${NAME//-/_}

BASE_DIR="$HOME/Desktop/coding/python"
TARGET_DIR="$BASE_DIR/$NAME"

header "üöÄ Creating Professional Project: $NAME"

# 1. Validation
mkdir -p "$BASE_DIR"
if [ -d "$TARGET_DIR" ]; then
  err "Project '$NAME' already exists in $BASE_DIR."
  exit 1
fi

# 2. Initialize Project
mkdir -p "$TARGET_DIR"
cd "$TARGET_DIR"

step "Initializing uv environment..."
# --lib creates the standard structure. We suppress output to keep it clean.
uv init --name "$NAME" --lib --quiet
uv add --dev ruff pytest --quiet

# 3. Construct 'Src Layout'
step "Structuring source code..."

# Fix: Remove existing src folder entirely to avoid Zsh glob errors
rm -rf src
mkdir -p "src/$PKG_NAME" "tests"

# A. __init__.py
touch "src/$PKG_NAME/__init__.py"

# B. main.py
cat <<EOF > "src/$PKG_NAME/main.py"
def main():
    """Entry point for the application script"""
    print(f"üöÄ $NAME is running from src/$PKG_NAME!")

if __name__ == "__main__":
    main()
EOF

# C. __main__.py
cat <<EOF > "src/$PKG_NAME/__main__.py"
from $PKG_NAME.main import main

if __name__ == "__main__":
    main()
EOF

# D. Basic Test
cat <<EOF > "tests/test_core.py"
from $PKG_NAME.main import main

def test_sanity():
    assert 1 + 1 == 2
EOF

# 4. Extras Setup
echo "# üìù To-Do: $NAME\n\n- [ ] Initial setup complete\n- [ ] " > todo.md

# 5. Git Setup
step "Initializing Git..."
git init -q
curl -s https://raw.githubusercontent.com/github/gitignore/main/Python.gitignore > .gitignore
echo "\n# Local Notes\ntodo.md" >> .gitignore
echo "\n# VSCode\n.vscode/" >> .gitignore

git add .
git commit -m "Initial setup with src layout" -q
ok "Local project structure created."

# 6. GitHub Automation
if command -v gh &>/dev/null; then
    echo "  üîí Creating PRIVATE repository on GitHub..."
    gh repo create "$NAME" --private --source=. --remote=origin --push > /dev/null
    ok "Live at https://github.com/cunhanina/$NAME (Private)"
else
    # Fallback if warn doesn't exist
    if command -v warn &>/dev/null; then
        warn "GitHub CLI not found. Project is local only."
    else
        echo "‚ö†Ô∏è  GitHub CLI not found. Project is local only."
    fi
fi

# 7. Final Handoff
if command -v code &>/dev/null; then
    code .
fi

info "üì¶ Package: src/$PKG_NAME"
info "üëâ Run it:  uv run -m $PKG_NAME"
