#!/bin/zsh
source ~/bin/_styles.sh

MSG="$1"
BRANCH=$(git rev-parse --abbrev-ref HEAD)

# 1. Default Message
if [ -z "$MSG" ]; then
    MSG="Update: $(date '+%Y-%m-%d %H:%M')"
fi

# 2. Check Git Context
if ! git rev-parse --git-dir > /dev/null 2>&1; then
    err "Not a git repository."
    exit 1
fi

header "üíæ Saving Progress ($BRANCH)..."

# 3. Add & Commit
# We check status first to avoid "nothing to commit" errors
if [ -n "$(git status --porcelain)" ]; then
    echo "  üëâ Adding files..."
    git add .
    echo "  üëâ Committing..."
    git commit -m "$MSG" -q
else
    echo "  üëâ No new changes to commit. checking for push..."
fi

# 4. Smart Push Logic
echo "  üëâ Checking remote status..."
git fetch -q # Update our knowledge of the cloud

# Check if we are behind (Remote has commits we don't)
# We use || echo 0 to handle cases where there is no upstream yet
BEHIND_COUNT=$(git rev-list HEAD..origin/$BRANCH --count 2>/dev/null || echo 0)

if [ "$BEHIND_COUNT" -gt 0 ]; then
    warn "‚ö†Ô∏è  Remote has changes you don't have!"
    echo "${BOLD}Incoming changes:${RESET}"
    git log HEAD..origin/$BRANCH --oneline --color | sed 's/^/  /'
    
    echo ""
    echo -n "  üîÑ Sync (pull) changes and push? [y/N] "
    read RESPONSE
    
    if [[ "$RESPONSE" =~ ^[Yy]$ ]]; then
        echo "  ‚¨áÔ∏è  Pulling changes..."
        if git pull --rebase -q; then
            echo "  ‚¨ÜÔ∏è  Pushing..."
            git push -q
            ok "Synced & Saved successfully!"
        else
            err "Pull failed (Conflict). Please fix manually."
            exit 1
        fi
    else
        warn "Push cancelled. Use 'git pull' manually when ready."
        exit 0
    fi
else
    # Standard Push
    echo "  ‚¨ÜÔ∏è  Pushing..."
    if git push -q; then
        ok "Saved & Pushed successfully!"
    else
        warn "Push failed (Check internet or permissions)."
    fi
fi
